rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isPastor() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role == 'pastor';
    }
    
    function isAdminOrPastor() {
      return isAdmin() || isPastor();
    }
    
    function isMemberOwner(memberId) {
      return isAuthenticated() && request.auth.uid == memberId;
    }
    
    function isValidMemberData() {
      return request.resource.data.keys().hasAll(['firstName', 'lastName']) &&
             (!('role' in request.resource.data) || request.resource.data.role in ['admin', 'pastor', 'member']) &&
             (!('memberStatus' in request.resource.data) || request.resource.data.memberStatus in ['active', 'inactive', 'regular_attender', 'visitor', 'participant', 'not_set']);
    }
    
    function hasRole(roles) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/members/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/members/$(request.auth.uid)).data.role in roles;
    }
    
    function isValidEventData() {
      return request.resource.data.keys().hasAll(['title', 'startDate', 'endDate', 'eventType', 'isPublic']) &&
             request.resource.data.eventType in ['service', 'bible_study', 'prayer_meeting', 'youth_group', 'seniors_group', 'womens_ministry', 'mens_ministry', 'special_event', 'outreach', 'volunteer_activity', 'board_meeting', 'training', 'other'] &&
             request.resource.data.isPublic is bool &&
             request.resource.data.isActive is bool &&
             (!('requiredRoles' in request.resource.data) || request.resource.data.requiredRoles is list);
    }

    function isValidRSVPData() {
      return request.resource.data.keys().hasAll(['eventId', 'memberId', 'status']) &&
             request.resource.data.status in ['yes', 'no', 'maybe', 'waitlist'] &&
             request.resource.data.numberOfGuests is number &&
             request.resource.data.numberOfGuests >= 0;
    }

    function canReadEvent(eventId) {
      let eventData = get(/databases/$(database)/documents/events/$(eventId)).data;
      return eventData.isPublic == true || 
             hasRole(eventData.requiredRoles) || 
             isAdminOrPastor();
    }

    function isEventCreator(eventId) {
      return get(/databases/$(database)/documents/events/$(eventId)).data.createdBy == request.auth.uid;
    }
    
    // Members collection
    match /members/{memberId} {
      // Anyone authenticated can read member profiles
      allow read: if isAuthenticated();
      
      // Members can update their own profile, admins/pastors can update any
      allow update: if isMemberOwner(memberId) || isAdminOrPastor();
      
      // Only admins/pastors can create new members
      allow create: if isAdminOrPastor() && isValidMemberData();
      
      // Only admins can delete members
      allow delete: if isAdmin();
      
      // Status history subcollection
      match /statusHistory/{historyId} {
        allow read: if isAuthenticated() && 
          (resource.data.changedBy == request.auth.uid || 
           hasRole(['admin', 'pastor']) ||
           memberId == request.auth.uid);
        
        allow create: if isAuthenticated() && 
          hasRole(['admin', 'pastor']) &&
          request.resource.data.keys().hasAll(['memberId', 'previousStatus', 'newStatus', 'changedBy', 'changedByName', 'changedAt']) &&
          request.resource.data.changedBy == request.auth.uid;
        
        allow update, delete: if false; // History should be immutable
      }
    }
    
    // Households collection  
    match /households/{householdId} {
      // Anyone authenticated can read household info
      allow read: if isAuthenticated();
      
      // Only admins/pastors can modify households
      allow write: if isAdminOrPastor();
    }
    
    // Registration Tokens collection - QR Self-Registration System
    match /registration_tokens/{tokenId} {
      // Anyone can read tokens (needed for public validation)
      allow read: if true;
      
      // Only admins/pastors can create/update/delete tokens
      allow write: if isAdminOrPastor();
    }
    
    // Pending Registrations collection - QR Self-Registration System
    match /pending_registrations/{registrationId} {
      // Anyone can create registrations (unauthenticated public access)
      allow create: if true;
      
      // Only admins/pastors can read/update/delete registrations
      allow read, update, delete: if isAdminOrPastor();
    }
    
    // Notes subcollection - Pastoral Care Security
    match /members/{memberId}/notes/{noteId} {
      allow read: if isAuthenticated() && 
        hasRole(['admin', 'pastor']) &&
        (resource.data.isPrivate == false || 
         resource.data.createdBy == request.auth.uid || 
         hasRole(['admin']));
      
      allow create: if isAuthenticated() && 
        hasRole(['admin', 'pastor']) &&
        request.resource.data.keys().hasAll(['memberId', 'title', 'content', 'category', 'priority', 'createdBy']) &&
        request.resource.data.createdBy == request.auth.uid;
      
      allow update: if isAuthenticated() && 
        hasRole(['admin', 'pastor']) &&
        (resource.data.createdBy == request.auth.uid || hasRole(['admin']));
      
      allow delete: if isAuthenticated() && 
        hasRole(['admin', 'pastor']) &&
        (resource.data.createdBy == request.auth.uid || hasRole(['admin']));
    }

    // Communications subcollection - Member Interaction Logging
    match /members/{memberId}/communications/{commId} {
      allow read, create: if isAuthenticated() && 
        hasRole(['admin', 'pastor']);
      
      allow update, delete: if isAuthenticated() && 
        hasRole(['admin']) ||
        (hasRole(['pastor']) && resource.data.recordedBy == request.auth.uid);
    }
    
    // Events collection
    match /events/{eventId} {
      // Read access rules
      allow read: if isAuthenticated() && (
        // Public events readable by all
        resource.data.isPublic == true ||
        // Private events readable by required roles
        hasRole(resource.data.requiredRoles) ||
        // Admin/pastor can read all events
        isAdminOrPastor()
      );
      
      // Write access rules
      allow create: if isAdminOrPastor() && 
        isValidEventData() &&
        request.resource.data.createdBy == request.auth.uid;
        
      allow update: if isAdminOrPastor() && 
        isValidEventData() &&
        // Preserve original creator
        request.resource.data.createdBy == resource.data.createdBy;
        
      allow delete: if isAdminOrPastor();
      
      // RSVP subcollection
      match /rsvps/{rsvpId} {
        // Members can read RSVPs for events they can access
        allow read: if isAuthenticated() && (
          // Can read own RSVP
          resource.data.memberId == request.auth.uid ||
          // Admin/pastor can read all RSVPs
          isAdminOrPastor() ||
          // Event creators can read RSVPs
          get(/databases/$(database)/documents/events/$(eventId)).data.createdBy == request.auth.uid
        );
        
        // RSVP creation rules
        allow create: if isAuthenticated() && 
          isValidRSVPData() &&
          request.resource.data.memberId == request.auth.uid &&
          // Can only RSVP to events you can read
          canReadEvent(eventId);
          
        // RSVP update rules
        allow update: if isAuthenticated() && (
          // Members can update their own RSVPs
          (resource.data.memberId == request.auth.uid && 
           request.resource.data.memberId == request.auth.uid) ||
          // Admin/pastor can update any RSVP
          isAdminOrPastor()
        ) && isValidRSVPData();
        
        // RSVP deletion rules
        allow delete: if isAuthenticated() && (
          resource.data.memberId == request.auth.uid ||
          isAdminOrPastor()
        );
      }
      
      // Attendance subcollection
      match /attendance/{attendanceId} {
        // Only admin/pastor can access attendance data
        allow read, write: if isAdminOrPastor();
      }
    }
    
    // Collection group for RSVP queries across events
    match /{path=**}/rsvps/{rsvpId} {
      allow read: if isAuthenticated() && (
        resource.data.memberId == request.auth.uid ||
        isAdminOrPastor()
      );
    }

    // Collection group for attendance queries across events
    match /{path=**}/attendance/{attendanceId} {
      allow read: if isAdminOrPastor();
    }

    // Enhanced Financial Data Helper Functions (PRP-2C-004)
    function isValidDonationData() {
      return request.resource.data.keys().hasAll(['amount', 'donationDate', 'method', 'categoryId', 'memberId']) &&
             request.resource.data.amount is number &&
             request.resource.data.amount > 0 &&
             request.resource.data.amount <= 1000000 && // Max $1M per donation
             request.resource.data.method in ['cash', 'check', 'credit_card', 'debit_card', 'bank_transfer', 'online', 'other'] &&
             request.resource.data.donationDate is timestamp &&
             request.resource.data.categoryId is string &&
             request.resource.data.memberId is string &&
             (!('status' in request.resource.data) || request.resource.data.status in ['pending', 'verified', 'cancelled']) &&
             (!('isAnonymous' in request.resource.data) || request.resource.data.isAnonymous is bool) &&
             (!('notes' in request.resource.data) || request.resource.data.notes is string) &&
             (!('taxDeductible' in request.resource.data) || request.resource.data.taxDeductible is bool) &&
             (!('checkNumber' in request.resource.data) || request.resource.data.checkNumber is string) &&
             (!('designatedFund' in request.resource.data) || request.resource.data.designatedFund is string);
    }

    function isValidDonationCategoryData() {
      return request.resource.data.keys().hasAll(['name', 'description', 'isActive', 'isTaxDeductible']) &&
             request.resource.data.name is string &&
             request.resource.data.name.size() > 0 &&
             request.resource.data.description is string &&
             request.resource.data.isActive is bool &&
             request.resource.data.isTaxDeductible is bool &&
             (!('displayOrder' in request.resource.data) || request.resource.data.displayOrder is number) &&
             (!('code' in request.resource.data) || request.resource.data.code is string) &&
             (!('fundCode' in request.resource.data) || request.resource.data.fundCode is string);
    }

    function canAccessFinancialData() {
      return isAdmin(); // Only admins have full financial access
    }

    function canMemberEditDonation(donationTimestamp) {
      // Members can only edit donations within 24 hours of creation
      let now = request.time;
      let createdAt = donationTimestamp;
      let hoursPassed = (now.toMillis() - createdAt.toMillis()) / (1000 * 60 * 60);
      return hoursPassed <= 24;
    }

    function requiresAuditLog() {
      // All financial data access requires audit logging
      return true;
    }

    function isValidFinancialQuery() {
      // Validate that financial queries are properly scoped
      return isAdmin() || 
             (isAuthenticated() && request.auth.uid != null);
    }

    // Donation Categories collection
    match /donation-categories/{categoryId} {
      // Admin: Full access to all categories with validation
      allow read, write: if isAdmin() && 
                           (request.method == 'read' || isValidDonationCategoryData());
      
      // Pastor: Read access to all categories, create/update active categories only
      allow read: if isPastor();
      allow create, update: if isPastor() && 
                              isValidDonationCategoryData() &&
                              request.resource.data.isActive == true;
      
      // Members: Read-only access to active categories only
      allow read: if isAuthenticated() && 
                     resource.data.isActive == true;
      
      // No deletion for non-admins
      allow delete: if isAdmin();
    }

    // Donations collection - Enhanced Security (PRP-2C-004)
    match /donations/{donationId} {
      // Admin: Full access to all donations with audit logging
      allow read: if canAccessFinancialData() && requiresAuditLog();
      allow write: if canAccessFinancialData() && 
                     isValidDonationData() &&
                     request.resource.data.createdBy == request.auth.uid;
      
      // CRITICAL: Pastors NO LONGER have access to individual donations
      // Pastors must use donation-summaries collection for aggregate data
      
      // Members: Read access ONLY to their own donations
      allow read: if isAuthenticated() && 
                     resource.data.memberId == request.auth.uid;
      
      // Members: Can create donations for themselves only
      allow create: if isAuthenticated() && 
                      isValidDonationData() &&
                      request.resource.data.memberId == request.auth.uid &&
                      request.resource.data.createdBy == request.auth.uid &&
                      request.resource.data.status == 'pending';
      
      // Members: Can update their own donations within 24-hour window and only if pending
      allow update: if isAuthenticated() && 
                      resource.data.memberId == request.auth.uid &&
                      request.resource.data.memberId == request.auth.uid &&
                      resource.data.status == 'pending' &&
                      canMemberEditDonation(resource.data.createdAt) &&
                      isValidDonationData();
      
      // Members: Cannot delete donations (audit trail preservation)
      // Only admins can delete donations
      allow delete: if isAdmin();
    }

    // Donation Summaries collection - Pastor Aggregate Access (PRP-2C-004)
    match /donation-summaries/{summaryId} {
      // Admin: Full access to all summaries
      allow read, write: if isAdmin();
      
      // Pastor: Read access to aggregate summaries (no individual donor details)
      allow read: if isPastor() && 
                     (resource.data.aggregationType in ['monthly', 'quarterly', 'yearly', 'category', 'fund']) &&
                     (!('individualDonorDetails' in resource.data) || resource.data.individualDonorDetails == false);
      
      // Pastors can create aggregate summaries but not individual donor summaries
      allow create, update: if isPastor() && 
                              request.resource.data.aggregationType in ['monthly', 'quarterly', 'yearly', 'category', 'fund'] &&
                              (!('individualDonorDetails' in request.resource.data) || request.resource.data.individualDonorDetails == false);
      
      // Members: No access to any summaries
      allow read, write: if false;
    }

    // Financial Audit Log collection - Admin Only (PRP-2C-004)
    match /financial-audit-log/{logId} {
      // Only admins can access audit logs
      allow read, write: if isAdmin();
      
      // System can create audit entries (server-side rules)
      allow create: if true; // Server-side validation handles this
    }

    // Collection group rules for donations (Enhanced Security)
    match /{path=**}/donations/{donationId} {
      // Admin: Can query across all donations with audit logging
      allow read: if isAdmin() && 
                     requiresAuditLog() &&
                     isValidFinancialQuery();
      
      // Members: Can only access their own donations in queries
      allow read: if isAuthenticated() && 
                     resource.data.memberId == request.auth.uid;
                     
      // No write access through collection group queries
      allow write: if false;
    }

    // Collection group rules for donation summaries
    match /{path=**}/donation-summaries/{summaryId} {
      // Admin: Full access to summary queries
      allow read: if isAdmin();
      
      // Pastor: Limited access to aggregate summaries only
      allow read: if isPastor() && 
                     resource.data.aggregationType in ['monthly', 'quarterly', 'yearly', 'category', 'fund'] &&
                     (!('individualDonorDetails' in resource.data) || resource.data.individualDonorDetails == false);
      
      // No write access through collection group queries
      allow write: if false;
    }
    
    // Default rule - deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}